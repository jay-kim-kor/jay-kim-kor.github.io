---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const experiences = (await getCollection('experience')).sort(
  (a, b) => a.data.order - b.data.order
);

interface Education {
  name: string;
  degree: string;
  major: string;
  period: string;
}

interface CertsData {
  education?: Education[];
}

let education: Education[] = [];

try {
  const yamlFiles = import.meta.glob('../content/certifications.yaml', { eager: true, query: '?raw', import: 'default' });
  const raw = Object.values(yamlFiles)[0] as string | undefined;
  if (raw) {
    const { load } = await import('js-yaml');
    const data = (load(raw) as CertsData) ?? {};
    education = data.education ?? [];
  }
} catch {
  // YAML 파일이 없으면 빈 상태 유지
}
---

<BaseLayout title="Experience" description="경력 및 학력">
  <h1 class="section-title">Experience</h1>

  {experiences.length === 0 ? (
    <div class="card text-center py-12">
      <p class="text-surface-500 dark:text-surface-400">콘텐츠 준비 중입니다.</p>
    </div>
  ) : (
    <div class="relative">
      <!-- Timeline line -->
      <div class="absolute left-4 md:left-8 top-0 bottom-0 w-px bg-surface-200 dark:bg-surface-800" />

      <div class="space-y-8">
        {experiences.map(async (exp) => {
          const { Content } = await exp.render();
          return (
            <div class="relative pl-12 md:pl-20">
              <!-- Timeline dot -->
              <div class="absolute left-3 md:left-7 top-2 w-3 h-3 rounded-full bg-primary-500 border-2 border-white dark:border-surface-950" />

              <div class="card">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-2">
                  <h3 class="text-lg font-semibold text-surface-900 dark:text-white">
                    {exp.data.role}
                  </h3>
                  <span class="text-sm text-surface-500 dark:text-surface-400 font-mono">
                    {exp.data.period}
                  </span>
                </div>
                <p class="text-primary-600 dark:text-primary-400 font-medium mb-3">
                  {exp.data.company}
                </p>
                <p class="text-sm text-surface-600 dark:text-surface-300 mb-4">
                  {exp.data.description}
                </p>
                <div class="prose prose-sm dark:prose-invert max-w-none mb-4">
                  <Content />
                </div>
                <div class="flex flex-wrap gap-2">
                  {exp.data.techStack.map((tech: string) => (
                    <span class="badge">{tech}</span>
                  ))}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  )}

  <!-- Education -->
  {education.length > 0 && (
    <div class="mt-16">
      <h2 class="section-title">Education</h2>
      <div class="relative">
        <div class="absolute left-4 md:left-8 top-0 bottom-0 w-px bg-surface-200 dark:bg-surface-800" />

        <div class="space-y-8">
          {education.map((edu) => (
            <div class="relative pl-12 md:pl-20">
              <div class="absolute left-3 md:left-7 top-2 w-3 h-3 rounded-full bg-surface-400 dark:bg-surface-600 border-2 border-white dark:border-surface-950" />

              <div class="card">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-2">
                  <h3 class="text-lg font-semibold text-surface-900 dark:text-white">
                    {edu.name}
                  </h3>
                  <span class="text-sm text-surface-500 dark:text-surface-400 font-mono">
                    {edu.period}
                  </span>
                </div>
                <p class="text-primary-600 dark:text-primary-400 font-medium">
                  {edu.degree} · {edu.major}
                </p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}
</BaseLayout>
