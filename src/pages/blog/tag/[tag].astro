---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  const tags = new Set<string>();
  posts.forEach((post) => post.data.tags.forEach((tag: string) => tags.add(tag)));

  return [...tags].map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags.includes(tag))
        .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()),
    },
  }));
}

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection<'blog'>>>;
}

const { tag, posts } = Astro.props;

function estimateReadTime(body: string): number {
  const words = body.trim().split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 200));
}
---

<BaseLayout title={`#${tag}`} description={`${tag} 태그 포스트 목록`}>
  <div class="mb-8">
    <a
      href="/career-hub/blog/"
      class="text-sm text-primary-500 hover:text-primary-600 dark:hover:text-primary-300 transition-colors"
    >
      &larr; 전체 목록
    </a>
  </div>

  <h1 class="section-title">
    #{tag}
    <span class="text-lg font-normal text-surface-500 dark:text-surface-400 ml-2">
      ({posts.length})
    </span>
  </h1>

  <div class="space-y-6">
    {posts.map((post) => (
      <a href={`/career-hub/blog/${post.id}/`} class="card block group">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-surface-900 dark:text-white group-hover:text-primary-500 dark:group-hover:text-primary-400 transition-colors">
            {post.data.title}
          </h3>
          <div class="flex items-center gap-3">
            <span class="text-xs text-surface-400 dark:text-surface-500">
              {estimateReadTime(post.body ?? '')} min read
            </span>
            <time
              datetime={post.data.publishDate.toISOString()}
              class="text-sm text-surface-500 dark:text-surface-400 font-mono"
            >
              {post.data.publishDate.toLocaleDateString('ko-KR')}
            </time>
          </div>
        </div>
        <p class="text-surface-600 dark:text-surface-300 text-sm mb-3">
          {post.data.description}
        </p>
        <div class="flex flex-wrap gap-2">
          {post.data.tags.map((t: string) => (
            <span class:list={['badge', { 'bg-primary-500/20 border-primary-500/40': t === tag }]}>
              {t}
            </span>
          ))}
        </div>
      </a>
    ))}
  </div>
</BaseLayout>
