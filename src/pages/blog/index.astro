---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// 모든 태그 추출 (중복 제거, 사용 빈도순 정렬)
const tagCounts = new Map<string, number>();
posts.forEach((post) => {
  post.data.tags.forEach((tag: string) => {
    tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
  });
});
const allTags = [...tagCounts.entries()]
  .sort((a, b) => b[1] - a[1])
  .map(([tag]) => tag);

function estimateReadTime(body: string): number {
  const words = body.trim().split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 200));
}
---

<BaseLayout title="Blog" description="기술 블로그">
  <h1 class="section-title">Blog</h1>

  {posts.length === 0 ? (
    <div class="card text-center py-12">
      <p class="text-surface-500 dark:text-surface-400">아직 작성된 글이 없습니다.</p>
    </div>
  ) : (
    <div>
      {/* Tags */}
      {allTags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-8">
          {allTags.map((tag) => (
            <a
              href={`/blog/tag/${tag}/`}
              class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-500/10 text-primary-600 dark:text-primary-400 border border-primary-500/20 hover:bg-primary-500/20 transition-colors"
            >
              {tag}
              <span class="ml-1.5 text-[10px] opacity-60">{tagCounts.get(tag)}</span>
            </a>
          ))}
        </div>
      )}

      {/* Posts */}
      <div class="space-y-6">
        {posts.map((post) => (
          <a href={`/blog/${post.id}/`} class="card block group">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-2">
              <h3 class="text-lg font-semibold text-surface-900 dark:text-white group-hover:text-primary-500 dark:group-hover:text-primary-400 transition-colors">
                {post.data.title}
              </h3>
              <div class="flex items-center gap-3">
                <span class="text-xs text-surface-400 dark:text-surface-500">
                  {estimateReadTime(post.body ?? '')} min read
                </span>
                <time
                  datetime={post.data.publishDate.toISOString()}
                  class="text-sm text-surface-500 dark:text-surface-400 font-mono"
                >
                  {post.data.publishDate.toLocaleDateString('ko-KR')}
                </time>
              </div>
            </div>
            <p class="text-surface-600 dark:text-surface-300 text-sm mb-3">
              {post.data.description}
            </p>
            <div class="flex flex-wrap gap-2">
              {post.data.tags.map((tag: string) => (
                <span class="badge">{tag}</span>
              ))}
            </div>
          </a>
        ))}
      </div>
    </div>
  )}
</BaseLayout>
